<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KVK Zoeken + OpenLayers Plot (Test)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size: 18px; margin: 0 8px 0 0; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    label { font-size: 12px; color:#555; }
    input, select, button { padding:8px 10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
    button { cursor:pointer; }
    main { display:grid; grid-template-columns: 380px 1fr; gap:0; height: calc(100vh - 58px); }
    #sidebar { border-right:1px solid #eee; overflow:auto; }
    #map { width:100%; height:100%; }
    .section { padding: 12px 14px; }
    .result { border:1px solid #eee; border-radius:10px; padding:10px; margin:8px 0; }
    .result h3 { margin:0; font-size:16px; }
    .muted { color:#666; font-size:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .stack { display:flex; flex-direction:column; gap:6px; }
    .error { color:#b00020; background:#fff2f2; border:1px solid #ffd7d7; padding:8px 10px; border-radius:8px; }
    .badge { display:inline-block; background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>KVK Zoeken → Plot op kaart (Test)</h1>
    <div class="controls">
      <label>API-base
        <select id="apiBase">
          <option value="https://developers.kvk.nl/test">developers.kvk.nl/test</option>
          <option value="https://api.kvk.nl/test">api.kvk.nl/test</option>
        </select>
      </label>
      <label style="min-width:280px;">API key
        <input id="apiKey" value="l7xx1f2691f2520d487b902f4e0b57a0b197" />
      </label>
      <label>Zoekveld
        <select id="searchField">
          <option value="kvkNummer">kvkNummer</option>
          <option value="naam">naam</option>
          <option value="plaats">plaats</option>
        </select>
      </label>
      <input id="searchValue" placeholder="bv. 90002520 of 'Beverwijk'" />
      <button id="btnSearch">Zoeken</button>
      <span id="status" class="muted"></span>
    </div>
  </header>
  <main>
    <aside id="sidebar">
      <div class="section">
        <div id="summary" class="muted">Voer een zoekopdracht uit. Resultaten verschijnen hieronder; klik “Plot op kaart”.</div>
        <div id="results"></div>
      </div>
    </aside>
    <section id="map"></section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    // --- OpenLayers kaart ---
    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM() })
      ],
      view: new ol.View({ center: ol.proj.fromLonLat([5.387, 52.156]), zoom: 7 })
    });

    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({ source: vectorSource });
    map.addLayer(vectorLayer);

    function addMarker(lon, lat, label) {
      const feature = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])), name: label });
      feature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({ radius: 6, fill: new ol.style.Fill({ color: '#2563eb' }), stroke: new ol.style.Stroke({ color: '#1e40af', width: 2 }) }),
        text: new ol.style.Text({ text: label || '', offsetY: -14, font: '12px sans-serif', fill: new ol.style.Fill({ color: '#111' }), stroke: new ol.style.Stroke({ color: '#fff', width: 3 }) })
      }));
      vectorSource.addFeature(feature);
      return feature;
    }

    function fitToFeatures() {
      const extent = vectorSource.getExtent();
      if (extent && extent.every(isFinite)) {
        map.getView().fit(extent, { padding: [30, 30, 30, 30], maxZoom: 16, duration: 400 });
      }
    }

    // --- Helpers ---
    async function kvkSearch({ base, apikey, field, value, pagina=1, perPagina=10 }) {
      const url = new URL(`${base}/api/v2/zoeken`);
      url.searchParams.set(field, value);
      url.searchParams.set('pagina', pagina);
      url.searchParams.set('resultatenPerPagina', perPagina);
      const res = await fetch(url.toString(), { headers: { 'apikey': apikey } });
      if (!res.ok) throw new Error(`Zoeken faalde: ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function kvkBasisprofiel({ base, apikey, kvkNummer, geoData=false }) {
      const url = new URL(`${base}/api/v1/basisprofielen/${kvkNummer}`);
      url.searchParams.set('geoData', String(geoData));
      const res = await fetch(url.toString(), { headers: { 'apikey': apikey } });
      if (!res.ok) throw new Error(`Basisprofiel faalde: ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function geocodePDOK(addressString) {
      // PDOK Locatieserver free endpoint – returns docs with centroide_ll as "POINT(lon lat)"
      const url = new URL('https://geodata.nationaalgeoregister.nl/locatieserver/v3/free');
      url.searchParams.set('q', addressString);
      url.searchParams.set('fq', 'type:adres');
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`Geocoding faalde: ${res.status} ${res.statusText}`);
      const data = await res.json();
      const doc = data.response && data.response.docs && data.response.docs[0];
      if (!doc || !doc.centroide_ll) throw new Error('Geen coordinaten gevonden voor: ' + addressString);
      const match = doc.centroide_ll.match(/POINT\(([-0-9.]+) ([0-9.]+)\)/);
      if (!match) throw new Error('Kon POINT niet parsen');
      return { lon: parseFloat(match[1]), lat: parseFloat(match[2]), doc };
    }

    function addressFromBasisprofiel(bp) {
      // Probeer eerst hoofdvestiging->bezoekadres, val desnoods terug op (eigenaar/maatschappelijke zetel) of postadres
      const hv = bp.hoofdvestiging || {};
      const bezoek = hv.bezoekadres || hv.adres || {};
      const post = hv.postadres || {};

      function fmt(a) {
        if (!a) return null;
        const parts = [];
        if (a.straatnaam) parts.push(a.straatnaam);
        if (a.huisnummer) parts.push(String(a.huisnummer) + (a.huisletter || ''));
        if (a.huisnummertoevoeging) parts.push(a.huisnummertoevoeging);
        const street = parts.join(' ');
        const city = [a.postcode, a.plaats].filter(Boolean).join(' ');
        return [street, city].filter(Boolean).join(', ');
      }

      return fmt(bezoek) || fmt(post) || null;
    }

    // UI refs
    const apiBaseEl = document.getElementById('apiBase');
    const apiKeyEl = document.getElementById('apiKey');
    const searchFieldEl = document.getElementById('searchField');
    const searchValueEl = document.getElementById('searchValue');
    const btnSearch = document.getElementById('btnSearch');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const summaryEl = document.getElementById('summary');

    function showStatus(text) { statusEl.textContent = text || ''; }
    function showError(msg) {
      statusEl.textContent = '';
      const div = document.createElement('div');
      div.className = 'error section';
      div.textContent = msg;
      resultsEl.prepend(div);
    }

    function renderResults(data, { base, apikey }) {
      resultsEl.innerHTML = '';
      summaryEl.textContent = `Pagina ${data.pagina} • ${data.resultaten?.length || 0} / totaal ${data.totaal}`;

      (data.resultaten || []).forEach((r, idx) => {
        const card = document.createElement('div');
        card.className = 'result stack';

        const title = document.createElement('h3');
        title.textContent = `${r.naam || '(naam onbekend)'} — ${r.kvkNummer || ''}`;
        card.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.textContent = `${r.type || ''}`;
        card.appendChild(meta);

        const row = document.createElement('div');
        row.className = 'row';

        const btnPlot = document.createElement('button');
        btnPlot.textContent = 'Plot op kaart';
        btnPlot.addEventListener('click', async () => {
          try {
            btnPlot.disabled = true; btnPlot.textContent = 'Bezig…';
            // 1) Basisprofiel ophalen
            const bp = await kvkBasisprofiel({ base, apikey, kvkNummer: r.kvkNummer, geoData: false });
            // 2) Adresstring bepalen
            const addr = addressFromBasisprofiel(bp);
            if (!addr) throw new Error('Geen adres gevonden in basisprofiel.');
            // 3) Geocoden via PDOK
            const { lon, lat } = await geocodePDOK(addr);
            // 4) Marker plaatsen
            addMarker(lon, lat, r.naam || r.kvkNummer);
            fitToFeatures();
            btnPlot.textContent = 'Geplot ✓';
          } catch (e) {
            showError(e.message);
            btnPlot.textContent = 'Plot op kaart';
          } finally {
            btnPlot.disabled = false;
          }
        });
        row.appendChild(btnPlot);

        const linkBasis = (r.links || []).find(l => (l.rel || '').toLowerCase() === 'basisprofiel');
        if (linkBasis) {
          const a = document.createElement('a');
          a.href = linkBasis.href; a.target = '_blank';
          a.textContent = 'Basisprofiel (JSON)'; a.rel = 'noreferrer noopener';
          row.appendChild(a);
        }

        card.appendChild(row);

        // Adres preview indien aanwezig in zoekresultaat
        const binnen = r.adres?.binnenlandsAdres?.straatnaam || r.adres?.binnenlandsAdres?.plaats ? document.createElement('div') : null;
        if (binnen) {
          binnen.className = 'muted';
          const straat = r.adres?.binnenlandsAdres?.straatnaam || '';
          const plaats = r.adres?.binnenlandsAdres?.plaats || '';
          binnen.innerHTML = `<span class="badge">adres (globaal):</span> ${straat} ${plaats}`;
          card.appendChild(binnen);
        }

        resultsEl.appendChild(card);
      });
    }

    btnSearch.addEventListener('click', async () => {
      vectorSource.clear();
      resultsEl.innerHTML = '';
      const base = apiBaseEl.value;
      const apikey = apiKeyEl.value.trim();
      const field = searchFieldEl.value;
      const value = searchValueEl.value.trim();
      if (!value) { showError('Vul een zoekwaarde in.'); return; }

      try {
        showStatus('Zoeken…');
        const data = await kvkSearch({ base, apikey, field, value, pagina:1, perPagina:10 });
        renderResults(data, { base, apikey });
        showStatus('');
      } catch (e) {
        showError(e.message);
        showStatus('');
      }
    });

    // Demo: prefill met voorbeeld uit je bericht
    searchFieldEl.value = 'kvkNummer';
    searchValueEl.value = '90002520';
  </script>
</body>
</html>
